<html>
    <head>
        <title>Basic sigma.js example</title>
        <style type="text/css">
            body {
                margin : 0px;
            }
            #container-1 {
                padding : 10px;
                width : 100%;
                height : 100%;
            }
            #container-2 {
                padding : 10px;
                width : 100%;
                height : 100%;
            }
        </style>
        <script src="http://code.jquery.com/jquery.min.js"></script>
        <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
        <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>        
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-2 col-sm-2 col-xs-2">
                    <form>
                        <label for="edgefilt">Edge Filter : </label>
                        <input class="form-control" type="text" id="edgefilt" value="100"/>
                        <button type="button" id="startForce">Start Force Layout</button>
                        <button type="button" id="endForce">End Force Layout</button>  
                        <button type="button" id="resetLayout">Reset Circular Layout</button>  
                        <button type="button" id="edgeWeight">Show Edge Weights</button>   
                        <button type="button" id="nodeDegree">Show Node Degree</button>                             
                    </form>
                    
                </div>
                <div class="col-md-5 col-sm-5 col-xs-5">
                    <div class="row">
                        <form>
                            <div class="form-group">
                                <label for="year-begin-1">Begin year : </label>
                                <input class="form-control" type="text" id="year-begin-1"/>
                            </div>
                            <div class="form-group">                                        
                                <label for="year-end-1">End year : </label>
                                <input class="form-control" type="text" id="year-end-1"/>
                            </div>
                            <div class="form-group">
                                <button type="button" id="year-button-1">Update Graph</button>
                            </div>
                        </form>
                    </div>
                    <div class="row">
                        <div id="container-1"></div>
                    </div>
                </div>
                <div class="col-md-5 col-sm-5 col-xs-5">
                    <div class="row">
                        <form>
                            <div class="form-group">
                                <label for="year-begin-2">Begin year : </label>
                                <input class="form-control" type="text" id="year-begin-2"/>
                            </div>
                            <div class="form-group">                                        
                                <label for="year-end-2">End year : </label>
                                <input class="form-control" type="text" id="year-end-2"/>
                            </div>
                            <div class="form-group">
                                    <button type="button" id="year-button-2">Update Graph</button>
                                </div>
                        </form>
                    </div>
                    <div class="row">
                        <div id="container-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="../sigma.js/build/sigma.min.js"></script>
        <script src="../sigma.js/build/plugins/sigma.layout.forceAtlas2.min.js"></script>
        <script src="../sigma.js/build/plugins/sigma.plugins.filter.js"></script>
        <script src="../sigma.js/build/plugins/sigma.layout.noverlap.min.js"></script>
        <script>  
            sigma.classes.graph.addMethod('nodeEdges', function(node) {
                var edges = {};
                var nodes = {};
                var n1 = this.inNeighborsIndex[node.id];
                var n2 = this.outNeighborsIndex[node.id];
                for(var n in n1) {
                    nodes[n] = n;
                    for (var e in n1[n]) {
                        if(!n1[n][e].hidden) {
                        edges[e] = n1[n][e]; }
                    }
                }
                for(var n in n2) {
                    nodes[n] = n;
                    for (var e in n2[n]) {
                        if(!n2[n][e].hidden) {
                        edges[e] = n2[n][e]; }
                    }
                }

                return edges;
            });
            var s1 = new sigma({
                    settings : {
                        drawLabels : false,
                        minNodeSize : 1,
                        maxNodeSize : 8,
                        minEdgeSize : 0,
                        maxEdgeSize : 8
                    }
                }); 
            var s2 = new sigma({
                    settings : {
                        drawLabels : false,
                        minNodeSize : 1,
                        maxNodeSize : 8,
                        minEdgeSize : 0,
                        maxEdgeSize : 8
                    }
                });            
            var sigmaplot = function(graph, container_name, color, remove_edges) {
                var nodes_list = graph['nodes'],
                    edges_list = graph['edges'];
                console.log(edges_list[0]);
                var s, so;
                if (remove_edges) {
                    s = s1;
                    so = s2;
                }
                else {
                    s = s2;
                    so = s1;
                }
                
                s.graph.read({
                    nodes: nodes_list,
                    edges: edges_list
                });
                
                
                var filter = new sigma.plugins.filter(s);
                filter.edgesBy(function(e) {
                    return e.weight > 100;
                }, 'edgefilt').apply();

                console.log(
                    s.graph.nodes().length,
                    s.graph.edges().length
                );

                s.graph.nodes().forEach(function(node, i, a) {
                    node.x = Math.cos(Math.PI * 2 * i / a.length);
                    node.y = Math.sin(Math.PI * 2 * i / a.length);
                    node.color = color;
                    node.size = 8;
                    node.label = node.id;
                    node.clicked = 0;
                });

                s.graph.edges().forEach(function(edge, i, a){
                    edge.color = '#ccc';
                    edge.type = "curve";
                });

                s.addRenderer({
                    type : 'canvas',
                    container : container_name
                });
                
                console.log(s);
                s.refresh();

                var updateEdges = function() {
                    var val = parseInt(document.getElementById('edgefilt').value);
                    filter.undo('edgefilt').edgesBy(function(e) {
                        return e.weight > val;
                    }, 'edgefilt').apply();
                }

                var edgefilt = document.getElementById('edgefilt');
                edgefilt.addEventListener('input', updateEdges);

                document.getElementById('startForce').addEventListener('click', function(e) {
                    s.startForceAtlas2();
                });
                document.getElementById('endForce').addEventListener('click', function(e) {
                    s.stopForceAtlas2();
                    s.startNoverlap();
                });

                document.getElementById('resetLayout').addEventListener('click', function(e) {
                    s.graph.nodes().forEach(function(node, i, a) {
                        node.x = Math.cos(Math.PI * 2 * i / a.length);
                        node.y = Math.sin(Math.PI * 2 * i / a.length);
                    });
                    s.refresh();
                });

                document.getElementById('edgeWeight').addEventListener('click', function(e){
                        s.graph.edges().forEach(function(edge, i, a){
                            edge.size = edge.weight;
                        });
                        s.refresh();
                });

                document.getElementById('nodeDegree').addEventListener('click', function(e){
                    s.graph.nodes().forEach(function(node, i, a) {
                        node.size = s.graph.degree(node.id);
                    });
                    s.refresh();
                });

                s.bind("overNode", function(node){
                    var neighbors = {};
                    var edges = s.graph.nodeEdges(node.data.node);
                    for(var e in edges) {
                        e = edges[e];
                        e.color = '#f00';
                        neighbors[e.source] = 1;
                        neighbors[e.target] = 1;
                    }
                    s.graph.nodes().forEach(function(node, i, a){
                        if (neighbors[node.id]) {
                            node.color = '#00f';
                        }
                    });
                    s.refresh();
                    if ('recurse' in node.data){ return; }

                    if(typeof so.graph.nodes(node.data.node.id) == 'undefined') {return;}
                    so.renderers[0].dispatchEvent('overNode', {node : so.graph.nodes(node.data.node.id), recurse : false});
                    
                });
                
                s.bind("outNode", function(node) {
                    var neighbors = {};
                    var edges = s.graph.nodeEdges(node.data.node);
                    for(var e in edges) {
                        e = edges[e];
                        e.color = '#ccc';
                        neighbors[e.source] = 1;
                        neighbors[e.target] = 1;
                    }
                    s.graph.nodes().forEach(function(node, i, a){
                        if (neighbors[node.id]) {
                            node.color = color;
                        }
                    });
                    s.refresh();
                    if('recurse' in node.data) { return; }
                    if(typeof so.graph.nodes(node.data.node.id) == 'undefined') {return;}

                    so.renderers[0].dispatchEvent('outNode', {node : so.graph.nodes(node.data.node.id), recurse : false});
                    
                });
            };

            document.getElementById('year-button-1').addEventListener('click', function(e){
                var y1 = document.getElementById('year-begin-1').value;
                var y2 = document.getElementById('year-end-1').value;
                d3.json(y1+"-"+y2+".json", function(data) {
                    sigmaplot(data, "container-1", "#0f0", true);
                });
            });

            document.getElementById('year-button-2').addEventListener('click', function(e){
                var y1 = document.getElementById('year-begin-2').value;
                var y2 = document.getElementById('year-end-2').value;
                d3.json(y1+"-"+y2+".json", function(data) {
                    sigmaplot(data, "container-2", "#f00", false);
                });
            });
        </script>
    </body>
</html>